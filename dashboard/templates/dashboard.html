<!DOCTYPE html>
<html lang="en" x-data="appData()" x-init="initApp()" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON SNIPER V3.5 ULTIMATE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        /* --- CYBERPUNK THEME ENGINE --- */
        :root { 
            --bg: #020202; --card: #080808; --border: #2a2a2a; 
            --accent: #00f0ff; --danger: #ff003c; --success: #00ff9d; --warn: #ffd700;
        }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Consolas', 'Monaco', monospace; overflow: hidden; }
        
        /* Glass Panel */
        .glass { 
            background: rgba(10, 10, 12, 0.9); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(10px); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6); 
        }
        
        /* Neon Texts */
        .neon-cyan { text-shadow: 0 0 10px rgba(0, 240, 255, 0.5); color: var(--accent); }
        .neon-red { text-shadow: 0 0 10px rgba(255, 0, 60, 0.5); color: var(--danger); }
        .neon-green { text-shadow: 0 0 10px rgba(0, 255, 157, 0.5); color: var(--success); }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #000; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Animation */
        @keyframes pulse-glow { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 15px currentColor; } 100% { opacity: 0.8; } }
        .animate-glow { animation: pulse-glow 2s infinite; }
        
        /* Table Row */
        .tr-hover:hover { background: rgba(255, 255, 255, 0.03); }
    </style>
</head>
<body class="flex flex-col h-screen text-xs selection:bg-cyan-500 selection:text-black">

    <header class="h-14 border-b border-gray-800 bg-[#050505] flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-crosshairs text-cyan-500 text-2xl animate-spin-slow"></i>
            <div>
                <h1 class="font-bold text-xl tracking-[0.2em] text-white">NEON<span class="neon-cyan">SNIPER</span></h1>
                <div class="text-[9px] text-gray-500 tracking-widest">AI AUTONOMOUS SYSTEM V3.5</div>
            </div>
        </div>

        <nav class="flex bg-gray-900/60 rounded p-1 gap-1 border border-gray-800">
            <button @click="tab='monitor'" :class="tab=='monitor'?'bg-cyan-900/30 text-cyan-400 border-cyan-500/50':'text-gray-500 border-transparent hover:text-gray-300'" class="px-6 py-2 rounded border transition font-bold tracking-wide"><i class="fa-solid fa-satellite-dish mr-2"></i>TACTICAL</button>
            <button @click="tab='history'" :class="tab=='history'?'bg-purple-900/30 text-purple-400 border-purple-500/50':'text-gray-500 border-transparent hover:text-gray-300'" class="px-6 py-2 rounded border transition font-bold tracking-wide"><i class="fa-solid fa-clipboard-list mr-2"></i>PERFORMANCE</button>
            <button @click="tab='brain'" :class="tab=='brain'?'bg-orange-900/30 text-orange-400 border-orange-500/50':'text-gray-500 border-transparent hover:text-gray-300'" class="px-6 py-2 rounded border transition font-bold tracking-wide"><i class="fa-solid fa-brain mr-2"></i>INTEL</button>
        </nav>

        <div class="flex items-center gap-4 text-right">
            <div>
                <div class="font-bold tracking-wider" :class="online ? 'text-green-500 neon-green' : 'text-red-500'" x-text="online ? 'SYSTEM ONLINE ●' : 'DISCONNECTED ○'"></div>
                <div class="text-[9px] text-gray-500 font-mono" x-text="timestamp">--:--:--</div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-3 overflow-hidden relative grid grid-cols-12 gap-3 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        
        <div x-show="tab === 'monitor'" class="col-span-12 grid grid-cols-12 gap-3 h-full">
            
            <div class="col-span-3 flex flex-col gap-3 h-full">
                
                <div class="glass p-5 rounded-xl border-l-4 transition-all duration-300" 
                     :class="market.pattern.includes('BUY') ? 'border-green-500 shadow-[0_0_20px_rgba(0,255,157,0.1)]' : market.pattern.includes('SELL') ? 'border-red-500 shadow-[0_0_20px_rgba(255,0,60,0.1)]' : 'border-gray-700'">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-400 font-bold uppercase tracking-wider text-[10px]">AI Target Scope</span>
                        <span x-show="market.pattern !== 'None'" class="animate-pulse px-2 py-0.5 rounded text-[9px] font-bold bg-white text-black tracking-widest">LOCKED</span>
                    </div>
                    <div class="text-center py-2">
                        <div class="text-3xl font-black tracking-widest break-words" 
                             :class="market.pattern.includes('BUY') ? 'neon-green' : market.pattern.includes('SELL') ? 'neon-red' : 'text-gray-600'"
                             x-text="market.pattern === 'None' ? 'SCANNING...' : market.pattern">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-gray-700/50">
                        <div class="text-center">
                            <div class="text-[9px] text-gray-500 mb-1">MOMENTUM</div>
                            <div class="font-bold text-white tracking-wide" x-text="market.momentum"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-[9px] text-gray-500 mb-1">ADX STRENGTH</div>
                            <div class="font-bold text-white tracking-wide" x-text="market.adx"></div>
                        </div>
                    </div>
                </div>

                <div class="glass p-4 rounded-xl">
                    <h3 class="text-[10px] text-gray-500 font-bold mb-3 uppercase flex justify-between">
                        <span><i class="fa-solid fa-trophy mr-2 text-yellow-500"></i>WIN RATE (LAST 100)</span>
                    </h3>
                    <div class="flex items-end gap-2 mb-2">
                        <span class="text-4xl font-bold font-mono" :class="stats.win_rate >= 50 ? 'text-green-400 neon-green' : 'text-red-400 neon-red'" x-text="stats.win_rate + '%'"></span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-1.5 mb-3 overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-1000" 
                             :class="stats.win_rate >= 50 ? 'bg-green-500' : 'bg-red-500'"
                             :style="'width: ' + stats.win_rate + '%'"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-mono text-gray-400">
                        <span>WINS: <b class="text-green-400" x-text="stats.wins"></b></span>
                        <span>LOSS: <b class="text-red-400" x-text="stats.losses"></b></span>
                        <span>TOTAL: <b class="text-white" x-text="stats.total"></b></span>
                    </div>
                </div>

                <div class="glass p-4 rounded-xl">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-500 text-[10px] font-bold">EQUITY</span>
                        <span class="text-cyan-500 bg-cyan-900/20 px-2 rounded text-[10px]" x-text="risk_mode"></span>
                    </div>
                    <div class="text-3xl font-mono font-bold text-white mb-2" x-text="fmt(equity)"></div>
                    <div class="flex justify-between text-[10px] font-mono border-t border-gray-800 pt-2">
                        <span class="text-gray-500">BALANCE: <span class="text-gray-300" x-text="fmt(balance)"></span></span>
                        <span :class="pnl>=0?'text-green-400':'text-red-400'" x-text="(pnl>=0?'+':'')+fmt(pnl)"></span>
                    </div>
                </div>

                <div class="glass p-4 rounded-xl mt-auto">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button @click="cmd('START')" class="py-3 bg-green-900/10 border border-green-500/30 text-green-400 font-bold hover:bg-green-500/20 rounded transition uppercase text-[10px] tracking-wider">
                            <i class="fa-solid fa-play mr-2"></i> START
                        </button>
                        <button @click="cmd('STOP')" class="py-3 bg-yellow-900/10 border border-yellow-500/30 text-yellow-400 font-bold hover:bg-yellow-500/20 rounded transition uppercase text-[10px] tracking-wider">
                            <i class="fa-solid fa-pause mr-2"></i> PAUSE
                        </button>
                    </div>
                    <button @click="cmd('CLOSE_ALL')" class="w-full py-2 bg-red-900/10 border border-red-500/50 text-red-500 font-bold hover:bg-red-900/30 rounded transition uppercase text-[10px] tracking-widest hover:shadow-[0_0_15px_rgba(255,0,60,0.3)]">
                        <i class="fa-solid fa-bomb mr-2"></i> PANIC CLOSE
                    </button>
                </div>
            </div>

            <div class="col-span-6 glass rounded-xl overflow-hidden border border-gray-800 relative shadow-2xl">
                <div class="absolute top-4 left-4 z-10 flex gap-2">
                     <span class="bg-black/80 px-3 py-1 rounded text-[10px] text-gray-300 border border-gray-700 backdrop-blur-sm">
                        <i class="fa-solid fa-chart-line text-cyan-500 mr-2"></i> <span x-text="market.symbol" class="font-bold"></span>
                     </span>
                     <span class="bg-black/80 px-3 py-1 rounded text-[10px] text-gray-300 border border-gray-700 backdrop-blur-sm">
                        H1 TREND: <span class="font-bold" :class="market.trend_h1.includes('BULL')?'text-green-400':market.trend_h1.includes('BEAR')?'text-red-400':'text-gray-400'" x-text="market.trend_h1"></span>
                     </span>
                </div>
                <div class="tradingview-widget-container" style="height:100%;width:100%">
                    <div id="tv_chart" style="height:100%;width:100%"></div>
                </div>
            </div>

            <div class="col-span-3 flex flex-col gap-3 h-full">
                <div class="glass p-0 rounded-xl flex-1 flex flex-col overflow-hidden relative max-h-[40%]">
                    <div class="p-3 border-b border-gray-800 bg-black/20 flex justify-between items-center">
                        <h3 class="text-[10px] text-gray-500 font-bold uppercase"><i class="fa-solid fa-list mr-2"></i>Open Positions</h3>
                        <span class="bg-gray-800 px-2 py-0.5 rounded text-white text-[10px]" x-text="positions.length">0</span>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-2 custom-scroll">
                        <template x-for="p in positions" :key="p.ticket">
                            <div class="bg-black/40 p-3 rounded border border-gray-700/50 hover:border-gray-500 transition cursor-pointer">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full" :class="p.type=='BUY'?'bg-blue-500':'bg-red-500'"></div>
                                        <span class="font-bold text-sm" :class="p.type=='BUY'?'text-blue-400':'text-red-400'" x-text="p.type"></span>
                                        <span class="text-gray-500 text-[10px]" x-text="p.volume + ' Lot'"></span>
                                    </div>
                                    <span class="font-mono font-bold text-sm" :class="p.profit>=0?'text-green-400':'text-red-400'" x-text="fmt(p.profit)"></span>
                                </div>
                                <div class="flex justify-between text-[10px] text-gray-500 font-mono">
                                    <span x-text="p.open_price"></span>
                                    <span>SL: <span x-text="p.sl" class="text-orange-400"></span></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="positions.length===0" class="h-full flex flex-col items-center justify-center text-gray-700 opacity-30">
                            <span class="text-[10px] tracking-widest">NO ACTIVE TRADES</span>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-xl flex-1 flex flex-col overflow-hidden border-t-2 border-purple-500">
                    <div class="p-3 bg-black/60 border-b border-gray-800 flex justify-between items-center">
                        <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest"><i class="fa-solid fa-microchip mr-2"></i>AI LOG</h3>
                        <i class="fa-solid fa-circle-notch fa-spin text-gray-600 text-[10px]"></i>
                    </div>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-3 space-y-3 bg-[#030303] custom-scroll">
                        <template x-for="msg in chats">
                            <div class="p-2 rounded border-l-2 text-[10px] relative group transition"
                                 :class="{
                                     'border-blue-500 bg-blue-900/5': msg.speaker.includes('Strategist'),
                                     'border-orange-500 bg-orange-900/5': msg.speaker.includes('Risk'),
                                     'border-green-500 bg-green-900/5': msg.speaker.includes('SYSTEM')
                                 }">
                                <div class="flex justify-between items-center mb-1 opacity-80">
                                    <span class="font-bold uppercase tracking-wider" 
                                          :class="{
                                              'text-blue-400': msg.speaker.includes('Strategist'),
                                              'text-orange-400': msg.speaker.includes('Risk'),
                                              'text-green-400': msg.speaker.includes('SYSTEM')
                                          }" x-text="msg.speaker"></span>
                                    <span class="text-[9px] text-gray-600 font-mono" x-text="msg.time"></span>
                                </div>
                                <div class="text-gray-300 leading-relaxed font-mono" x-text="msg.message"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="tab === 'history'" class="col-span-12 glass rounded-xl p-6 overflow-auto" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white tracking-widest mb-1"><i class="fa-solid fa-chart-line text-purple-500 mr-3"></i>TRADING PERFORMANCE</h2>
                    <p class="text-gray-500 text-[10px]">Detailed breakdown of executed trades.</p>
                </div>
                <button @click="fetchHistory(); fetchJournal()" class="px-4 py-2 bg-gray-800 rounded border border-gray-700 hover:bg-gray-700 text-[10px] transition font-bold">
                    <i class="fa-solid fa-sync mr-2"></i> REFRESH DATA
                </button>
            </div>

            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="glass p-4 rounded-lg bg-black/40 border-l-4 border-green-500">
                    <div class="text-gray-500 text-[10px] font-bold uppercase mb-1">Win Rate</div>
                    <div class="text-3xl font-mono font-bold text-white" x-text="stats.win_rate + '%'"></div>
                </div>
                <div class="glass p-4 rounded-lg bg-black/40 border-l-4 border-blue-500">
                    <div class="text-gray-500 text-[10px] font-bold uppercase mb-1">Net Profit</div>
                    <div class="text-3xl font-mono font-bold" :class="stats.net_profit >= 0 ? 'text-green-400' : 'text-red-400'" x-text="fmt(stats.net_profit)"></div>
                </div>
                <div class="glass p-4 rounded-lg bg-black/40 border-l-4 border-purple-500">
                    <div class="text-gray-500 text-[10px] font-bold uppercase mb-1">Total Trades</div>
                    <div class="text-3xl font-mono font-bold text-white" x-text="stats.total"></div>
                </div>
                <div class="glass p-4 rounded-lg bg-black/40 border-l-4 border-orange-500">
                    <div class="text-gray-500 text-[10px] font-bold uppercase mb-1">W/L Count</div>
                    <div class="text-3xl font-mono font-bold text-white" x-text="stats.wins + ' / ' + stats.losses"></div>
                </div>
            </div>
            
            <div class="overflow-hidden rounded-xl border border-gray-800 bg-black/40">
                <table class="w-full text-left text-[11px] border-collapse">
                    <thead class="bg-gray-900/90 text-gray-400 uppercase tracking-wider font-bold backdrop-blur">
                        <tr>
                            <th class="p-4 w-32 border-b border-gray-800">Time</th>
                            <th class="p-4 w-20 border-b border-gray-800">Type</th>
                            <th class="p-4 w-20 border-b border-gray-800">Lot</th>
                            <th class="p-4 w-32 text-right border-b border-gray-800">Profit</th>
                            <th class="p-4 border-b border-gray-800">Analysis</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        <template x-for="h in history">
                            <tr class="hover:bg-white/5 transition tr-hover group">
                                <td class="p-4 text-gray-500 font-mono" x-text="h.closed_at || '-'"></td>
                                <td class="p-4">
                                    <span class="px-2 py-1 rounded font-bold text-[10px] uppercase" 
                                          :class="h.type=='BUY'?'bg-blue-900/20 text-blue-400 border border-blue-500/30':'bg-red-900/20 text-red-400 border border-red-500/30'" 
                                          x-text="h.type"></span>
                                </td>
                                <td class="p-4 text-gray-300 font-mono" x-text="h.volume"></td>
                                <td class="p-4 text-right">
                                    <span class="font-mono font-bold text-lg" 
                                          :class="h.profit>=0?'text-green-400':'text-red-400'" 
                                          x-text="fmt(h.profit)"></span>
                                </td>
                                <td class="p-4 text-gray-400 italic">
                                    <div x-data="{ analysis: journal.find(j => j.ticket === h.ticket) }">
                                        <template x-if="analysis">
                                            <span><i class="fa-solid fa-robot text-purple-500 mr-2"></i><span x-text="analysis.lesson"></span></span>
                                        </template>
                                        <template x-if="!analysis">
                                            <span x-text="h.reason"></span>
                                        </template>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="tab === 'brain'" class="col-span-12 glass rounded-xl p-6 overflow-auto" style="display: none;">
             <h2 class="text-2xl font-bold text-white mb-6 tracking-widest"><i class="fa-solid fa-brain text-orange-500 mr-3"></i>AI MEMORY</h2>
             <div class="grid grid-cols-3 gap-4">
                <template x-for="mem in journal">
                    <div class="bg-black/40 border border-gray-800 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-500" x-text="mem.date"></span>
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold" :class="mem.result=='WIN'?'bg-green-900 text-green-400':'bg-red-900 text-red-400'" x-text="mem.result"></span>
                        </div>
                        <div class="text-white text-sm italic">"<span x-text="mem.lesson"></span>"</div>
                    </div>
                </template>
            </div>
        </div>

    </main>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        function appData() {
            return {
                tab: 'monitor',
                online: false,
                timestamp: '',
                balance: 0, equity: 0, pnl: 0, risk_mode: 'STD',
                market: { symbol: 'XAUUSD', pattern: 'None', trend_h1: '-', momentum: '-', adx: '-' },
                positions: [], chats: [], journal: [], history: [],
                stats: { win_rate: 0, wins: 0, losses: 0, total: 0, net_profit: 0 },

                initApp() {
                    new TradingView.widget({
                        "autosize": true, "symbol": "OANDA:XAUUSD", "interval": "15",
                        "timezone": "Asia/Jakarta", "theme": "dark", "style": "1", "locale": "en",
                        "toolbar_bg": "#f1f3f6", "enable_publishing": false, "container_id": "tv_chart"
                    });
                    
                    setInterval(() => this.fetchStatus(), 1000);
                    setInterval(() => this.fetchChat(), 2000);
                    setInterval(() => { this.fetchJournal(); this.fetchHistory(); }, 5000);
                },

                async fetchStatus() {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        this.online = true;
                        if(data.market) this.market = data.market;
                        if(data.account) {
                            this.balance = data.account.balance;
                            this.equity = data.account.equity;
                            this.pnl = this.equity - this.balance;
                        }
                        if(data.positions) this.positions = data.positions;
                        if(data.risk_profile) this.risk_mode = data.risk_profile.mode;
                        this.timestamp = new Date().toLocaleTimeString();
                    } catch { this.online = false; }
                },

                async fetchChat() { try { this.chats = (await (await fetch('/api/chat')).json()).reverse(); } catch {} },
                async fetchJournal() { try { this.journal = (await (await fetch('/api/journal')).json()); } catch {} },
                
                async fetchHistory() { 
                    try { 
                        const raw = await (await fetch('/api/history')).json();
                        // Handle jika data yang datang bukan array (perbaikan bug backend lama)
                        if (Array.isArray(raw)) {
                            this.history = raw.reverse();
                            
                            // CALCULATE STATS
                            let wins = 0, losses = 0, profit = 0;
                            const recent = this.history.slice(0, 100);
                            
                            recent.forEach(h => {
                                profit += h.profit;
                                if(h.profit >= 0) wins++; else losses++;
                            });
                            
                            const total = wins + losses;
                            this.stats = {
                                win_rate: total > 0 ? ((wins / total) * 100).toFixed(1) : 0,
                                wins: wins, losses: losses, total: total, net_profit: profit
                            };
                        }
                    } catch {} 
                },

                async cmd(c) {
                    if(!confirm('CONFIRM: ' + c + '?')) return;
                    try { await fetch('/api/control', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({command:c})}); } catch {}
                },

                fmt(n) { return new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n); }
            }
        }
    </script>
</body>
</html>